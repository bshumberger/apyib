import psi4
import numpy as np
import apyib
import pytest
from ..data.molecules import *

def test_rhf_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O_C4_HF"],
                  'basis': 'STO-3G',
                  'method': 'RHF',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting RHF reference Hessian from CFOUR HF/STO-3G optimized geometry.
    hess_ref = np.array([
     [  0.0000002355,        0.0000000000,        0.0000000000],
     [ -0.0000001178,        0.0000000000,        0.0000000000],
     [ -0.0000001178,        0.0000000000,        0.0000000000],
     [  0.0000000000,        0.8039499964,        0.0000000000],
     [  0.0000000000,       -0.4019749982,       -0.3371363249],
     [  0.0000000000,       -0.4019749982,        0.3371363249],
     [  0.0000000000,        0.0000000000,        0.6348993605],
     [  0.0000000000,       -0.2163116072,       -0.3174496803],
     [  0.0000000000,        0.2163116072,       -0.3174496803],
     [ -0.0000001178,        0.0000000000,        0.0000000000],
     [  0.0000001262,        0.0000000000,        0.0000000000],
     [ -0.0000000084,        0.0000000000,        0.0000000000],
     [  0.0000000000,       -0.4019749982,       -0.2163116072],
     [  0.0000000000,        0.4389111622,        0.2767239660],
     [  0.0000000000,       -0.0369361640,       -0.0604123588],
     [  0.0000000000,       -0.3371363249,       -0.3174496803],
     [  0.0000000000,        0.2767239660,        0.3001030221],
     [  0.0000000000,        0.0604123588,        0.0173466582],
     [ -0.0000001178,        0.0000000000,        0.0000000000],
     [ -0.0000000084,        0.0000000000,        0.0000000000],
     [  0.0000001262,        0.0000000000,        0.0000000000],
     [  0.0000000000,       -0.4019749982,        0.2163116072],
     [  0.0000000000,       -0.0369361640,        0.0604123588],
     [  0.0000000000,        0.4389111622,       -0.2767239660],
     [  0.0000000000,        0.3371363249,       -0.3174496803],
     [  0.0000000000,       -0.0604123588,        0.0173466582],
     [  0.0000000000,       -0.2767239660,        0.3001030221]
    ])
    
    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-6)

def test_mp2_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O_C4_MP2"],
                  'basis': 'STO-3G',
                  'method': 'MP2',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
    [   0.0000000001,       -0.0000000000,       -0.0000000000],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [  -0.0000000000,        0.6608196899,       -0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.2909106155],
    [  -0.0000000000,       -0.3304098449,        0.2909106155],
    [  -0.0000000000,       -0.0000000000,        0.5495711873],
    [   0.0000000000,       -0.1762837568,       -0.2747855936],
    [   0.0000000000,        0.1762837568,       -0.2747855936],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.0000000000,       -0.0000000000],
    [   0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.1762837569],
    [  -0.0000000000,        0.3678952802,        0.2335971862],
    [  -0.0000000000,       -0.0374854352,       -0.0573134293],
    [   0.0000000000,       -0.2909106156,       -0.2747855936],
    [  -0.0000000000,        0.2335971862,        0.2654594806],
    [   0.0000000000,        0.0573134294,        0.0093261131],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000000,        0.0000000000,       -0.0000000000],
    [  -0.0000000000,       -0.3304098449,        0.1762837569],
    [   0.0000000000,       -0.0374854352,        0.0573134293],
    [   0.0000000000,        0.3678952802,       -0.2335971862],
    [   0.0000000000,        0.2909106156,       -0.2747855936],
    [   0.0000000000,       -0.0573134294,        0.0093261131],
    [  -0.0000000000,       -0.2335971862,        0.2654594806],
    ])
 
    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-6)

def test_mp2_SO_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O_C4_MP2"],
                  'basis': 'STO-3G',
                  'method': 'MP2_SO',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
    [   0.0000000001,       -0.0000000000,       -0.0000000000],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [  -0.0000000000,        0.6608196899,       -0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.2909106155],
    [  -0.0000000000,       -0.3304098449,        0.2909106155],
    [  -0.0000000000,       -0.0000000000,        0.5495711873],
    [   0.0000000000,       -0.1762837568,       -0.2747855936],
    [   0.0000000000,        0.1762837568,       -0.2747855936],
    [  -0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.0000000000,       -0.0000000000],
    [   0.0000000001,        0.0000000000,        0.0000000000],
    [   0.0000000000,       -0.3304098449,       -0.1762837569],
    [  -0.0000000000,        0.3678952802,        0.2335971862],
    [  -0.0000000000,       -0.0374854352,       -0.0573134293],
    [   0.0000000000,       -0.2909106156,       -0.2747855936],
    [  -0.0000000000,        0.2335971862,        0.2654594806],
    [   0.0000000000,        0.0573134294,        0.0093261131],
    [  -0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000001,       -0.0000000000,        0.0000000000],
    [   0.0000000000,        0.0000000000,       -0.0000000000],
    [  -0.0000000000,       -0.3304098449,        0.1762837569],
    [   0.0000000000,       -0.0374854352,        0.0573134293],
    [   0.0000000000,        0.3678952802,       -0.2335971862],
    [   0.0000000000,        0.2909106156,       -0.2747855936],
    [   0.0000000000,       -0.0573134294,        0.0093261131],
    [  -0.0000000000,       -0.2335971862,        0.2654594806],
    ])  
 
    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-6)

def test_cid_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O_C4_CID"],
                  'basis': 'STO-3G',
                  'method': 'CID',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
     [  0.0000000000,        0.0000003053,        0.0000002035],
     [ -0.0000002699,       -0.0000003146,        0.0000003301],
     [  0.0000002699,        0.0000000000,       -0.0000005337],
     [  0.0000003053,        0.5894600186,        0.0000004070],
     [ -0.0000004766,       -0.2947303332,       -0.2613836255],
     [  0.0000001713,       -0.2947296854,        0.2613832185],
     [  0.0000002035,        0.0000004070,        0.5172143285],
     [ -0.0000004257,       -0.1557235360,       -0.2586071103],
     [  0.0000002222,        0.1557231290,       -0.2586072182],
     [ -0.0000002699,       -0.0000004766,       -0.0000004257],
     [  0.0000006710,        0.0000001760,       -0.0000001463],
     [ -0.0000004010,        0.0000003005,        0.0000005720],
     [ -0.0000003146,       -0.2947303332,       -0.1557235360],
     [  0.0000001760,        0.3327798576,        0.2085535363],
     [  0.0000001386,       -0.0380495244,       -0.0528300003],
     [  0.0000003301,       -0.2613836255,       -0.2586071103],
     [ -0.0000001463,        0.2085535363,        0.2452085405],
     [ -0.0000001838,        0.0528300892,        0.0133985698],
     [  0.0000002699,        0.0000001713,        0.0000002222],
     [ -0.0000004010,        0.0000001386,       -0.0000001838],
     [  0.0000001311,       -0.0000003098,       -0.0000000384],
     [  0.0000000000,       -0.2947296854,        0.1557231290],
     [  0.0000003005,       -0.0380495244,        0.0528300892],
     [ -0.0000003098,        0.3327792098,       -0.2085532182],
     [ -0.0000005337,        0.2613832185,       -0.2586072182],
     [  0.0000005720,       -0.0528300003,        0.0133985698],
     [ -0.0000000384,       -0.2085532182,        0.2452086484],
    ])

    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-6)

def test_cid_SO_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O_C4_CID"],
                  'basis': 'STO-3G',
                  'method': 'CID_SO',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
     [  0.0000000000,        0.0000003053,        0.0000002035],
     [ -0.0000002699,       -0.0000003146,        0.0000003301],
     [  0.0000002699,        0.0000000000,       -0.0000005337],
     [  0.0000003053,        0.5894600186,        0.0000004070],
     [ -0.0000004766,       -0.2947303332,       -0.2613836255],
     [  0.0000001713,       -0.2947296854,        0.2613832185],
     [  0.0000002035,        0.0000004070,        0.5172143285],
     [ -0.0000004257,       -0.1557235360,       -0.2586071103],
     [  0.0000002222,        0.1557231290,       -0.2586072182],
     [ -0.0000002699,       -0.0000004766,       -0.0000004257],
     [  0.0000006710,        0.0000001760,       -0.0000001463],
     [ -0.0000004010,        0.0000003005,        0.0000005720],
     [ -0.0000003146,       -0.2947303332,       -0.1557235360],
     [  0.0000001760,        0.3327798576,        0.2085535363],
     [  0.0000001386,       -0.0380495244,       -0.0528300003],
     [  0.0000003301,       -0.2613836255,       -0.2586071103],
     [ -0.0000001463,        0.2085535363,        0.2452085405],
     [ -0.0000001838,        0.0528300892,        0.0133985698],
     [  0.0000002699,        0.0000001713,        0.0000002222],
     [ -0.0000004010,        0.0000001386,       -0.0000001838],
     [  0.0000001311,       -0.0000003098,       -0.0000000384],
     [  0.0000000000,       -0.2947296854,        0.1557231290],
     [  0.0000003005,       -0.0380495244,        0.0528300892],
     [ -0.0000003098,        0.3327792098,       -0.2085532182],
     [ -0.0000005337,        0.2613832185,       -0.2586072182],
     [  0.0000005720,       -0.0528300003,        0.0133985698],
     [ -0.0000000384,       -0.2085532182,        0.2452086484],
    ])  

    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-6)

def test_cisd_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O"],
                  'basis': '6-31G',
                  'method': 'CISD',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
     [ 2.72568647e-01,  6.26497119e-06, -1.95163468e-06],
     [-1.36282818e-01, -7.95900942e-02, -1.26924486e-08],
     [-1.36285829e-01,  7.95838292e-02,  1.96432713e-06],
     [ 6.26497119e-06,  2.20100093e-01, -1.52528696e-06],
     [-2.57595784e-02, -1.10050610e-01,  3.46940291e-07],
     [ 2.57533134e-02, -1.10049482e-01,  1.17834667e-06],
     [-1.95163468e-06, -1.52528696e-06,  6.88349550e-02],
     [ 1.93269586e-07,  1.42597880e-07, -3.44171803e-02],
     [ 1.75836510e-06,  1.38268908e-06, -3.44177747e-02],
     [-1.36282818e-01, -2.57595784e-02,  1.93269586e-07],
     [ 1.62988626e-01,  5.26743377e-02, -3.09173318e-07],
     [-2.67058080e-02, -2.69147594e-02,  1.15903732e-07],
     [-7.95900942e-02, -1.10050610e-01,  1.42597880e-07],
     [ 5.26743377e-02,  1.03865706e-01, -7.12603654e-08],
     [ 2.69157565e-02,  6.18490466e-03, -7.13375144e-08],
     [-1.26924486e-08,  3.46940291e-07, -3.44171803e-02],
     [-3.09173318e-07, -7.12603654e-08,  3.49586919e-02],
     [ 3.21865766e-07, -2.75679926e-07, -5.41511646e-04],
     [-1.36285829e-01,  2.57533134e-02,  1.75836510e-06],
     [-2.67058080e-02,  2.69157565e-02,  3.21865766e-07],
     [ 1.62991637e-01, -5.26690698e-02, -2.08023086e-06],
     [ 7.95838292e-02, -1.10049482e-01,  1.38268908e-06],
     [-2.69147594e-02,  6.18490466e-03, -2.75679926e-07],
     [-5.26690698e-02,  1.03864577e-01, -1.10700915e-06],
     [ 1.96432713e-06,  1.17834667e-06, -3.44177747e-02],
     [ 1.15903732e-07, -7.13375144e-08, -5.41511646e-04],
     [-2.08023086e-06, -1.10700915e-06,  3.49592863e-02],
    ])

    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-5)

@pytest.mark.skip(reason="Too slow.")
def test_cisd_SO_hessian():
    # Set parameters for the calculation.
    parameters = {'geom': moldict["H2O"],
                  'basis': '6-31G',
                  'method': 'CISD_SO',
                  'e_convergence': 1e-12,
                  'd_convergence': 1e-12,
                  'DIIS': True,
                  'freeze_core': False,
                  'F_el': [0.0, 0.0, 0.0],
                  'F_mag': [0.0, 0.0, 0.0],
                  'max_iterations': 120}

    # Setting MP2 reference Hessian from CFOUR MP2/STO-3G optimized geometry.
    hess_ref = np.array([
     [ 2.72568647e-01,  6.26497119e-06, -1.95163468e-06],
     [-1.36282818e-01, -7.95900942e-02, -1.26924486e-08],
     [-1.36285829e-01,  7.95838292e-02,  1.96432713e-06],
     [ 6.26497119e-06,  2.20100093e-01, -1.52528696e-06],
     [-2.57595784e-02, -1.10050610e-01,  3.46940291e-07],
     [ 2.57533134e-02, -1.10049482e-01,  1.17834667e-06],
     [-1.95163468e-06, -1.52528696e-06,  6.88349550e-02],
     [ 1.93269586e-07,  1.42597880e-07, -3.44171803e-02],
     [ 1.75836510e-06,  1.38268908e-06, -3.44177747e-02],
     [-1.36282818e-01, -2.57595784e-02,  1.93269586e-07],
     [ 1.62988626e-01,  5.26743377e-02, -3.09173318e-07],
     [-2.67058080e-02, -2.69147594e-02,  1.15903732e-07],
     [-7.95900942e-02, -1.10050610e-01,  1.42597880e-07],
     [ 5.26743377e-02,  1.03865706e-01, -7.12603654e-08],
     [ 2.69157565e-02,  6.18490466e-03, -7.13375144e-08],
     [-1.26924486e-08,  3.46940291e-07, -3.44171803e-02],
     [-3.09173318e-07, -7.12603654e-08,  3.49586919e-02],
     [ 3.21865766e-07, -2.75679926e-07, -5.41511646e-04],
     [-1.36285829e-01,  2.57533134e-02,  1.75836510e-06],
     [-2.67058080e-02,  2.69157565e-02,  3.21865766e-07],
     [ 1.62991637e-01, -5.26690698e-02, -2.08023086e-06],
     [ 7.95838292e-02, -1.10049482e-01,  1.38268908e-06],
     [-2.69147594e-02,  6.18490466e-03, -2.75679926e-07],
     [-5.26690698e-02,  1.03864577e-01, -1.10700915e-06],
     [ 1.96432713e-06,  1.17834667e-06, -3.44177747e-02],
     [ 1.15903732e-07, -7.13375144e-08, -5.41511646e-04],
     [-2.08023086e-06, -1.10700915e-06,  3.49592863e-02],
    ])  

    # Compute energy.
    E_list, T_list, C, basis = apyib.energy.energy(parameters)

    # Compute finite difference Hessian using apyib.
    finite_difference = apyib.fin_diff.finite_difference(parameters, basis, C)
    hessian = finite_difference.compute_Hessian(0.001)

    assert(np.max(np.abs(hessian-hess_ref.reshape(9,9))) < 1e-5)
